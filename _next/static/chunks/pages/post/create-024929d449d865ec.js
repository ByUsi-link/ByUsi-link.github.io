(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[167],{70333:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/post/create",function(){return n(19604)}])},19604:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return CreatePost}});var l=n(85893),a=n(67294),i=n(66242),r=n(44267),s=n(15861),o=n(21737),c=n(5616),d=n(19273),u=n(18972),h=n(87109),x=n(93946),g=n(87918),m=n(11057),j=n(96540),p=n(50594),Z=n(11163),f=n(55826),v=n(68540),y=n(1292),C=n(90629),b=n(22961),k=n(77957),w=n(56693),T=n(61193),I=n(68614),S=n(85938),_=n(26426),E=n(43800),P=n(96214),R=n(25332),W=n(4958),N=n(34209),A=n(84283),M=n(46435),components_MarkdownEditor=e=>{let{value:t,onChange:n,label:i="内容",height:r=400}=e,[o,u]=a.useState(!1),h=(0,a.useRef)(null),handleInsertText=function(e){let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",a=document.querySelector("textarea");if(!a)return;let i=a.selectionStart,r=a.selectionEnd,s=t.substring(i,r),o=t.substring(0,i)+e+s+l+t.substring(r);n(o),setTimeout(()=>{a.focus(),a.setSelectionRange(i+e.length,i+e.length+s.length)},0)},handleImageUpload=async e=>{var t;let n=null===(t=e.target.files)||void 0===t?void 0:t[0];if(n){if(!n.type.startsWith("image/")){alert("请上传图片文件");return}try{let e=await M.sC.uploadImage(n);if(e.success&&e.data){let t="![图片](".concat(e.data.url,")");handleInsertText(t)}}catch(e){console.error("图片上传失败:",e),alert("图片上传失败，请重试")}finally{h.current&&(h.current.value="")}}},g=[{icon:(0,l.jsx)(T.Z,{}),tooltip:"粗体",onClick:()=>handleInsertText("**","**")},{icon:(0,l.jsx)(I.Z,{}),tooltip:"斜体",onClick:()=>handleInsertText("*","*")},{icon:(0,l.jsx)(E.Z,{}),tooltip:"链接",onClick:()=>handleInsertText("[","](url)")},{icon:(0,l.jsx)(P.Z,{}),tooltip:"代码",onClick:()=>handleInsertText("`","`")},{icon:(0,l.jsx)(S.Z,{}),tooltip:"无序列表",onClick:()=>handleInsertText("- ")},{icon:(0,l.jsx)(_.Z,{}),tooltip:"有序列表",onClick:()=>handleInsertText("1. ")}];return(0,l.jsxs)(c.Z,{sx:{width:"100%"},children:[(0,l.jsxs)(c.Z,{sx:{borderBottom:1,borderColor:"divider",mb:2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,l.jsxs)(v.Z,{variant:"outlined",size:"small",children:[(0,l.jsx)(m.Z,{variant:o?"outlined":"contained",onClick:()=>u(!1),startIcon:(0,l.jsx)(k.Z,{}),children:"编辑"}),(0,l.jsx)(m.Z,{variant:o?"contained":"outlined",onClick:()=>u(!0),startIcon:(0,l.jsx)(b.Z,{}),children:"预览"})]}),!o&&(0,l.jsxs)(c.Z,{children:[(0,l.jsx)("input",{type:"file",accept:"image/*",ref:h,onChange:handleImageUpload,style:{display:"none"}}),(0,l.jsx)(y.Z,{title:"上传图片",children:(0,l.jsx)(x.Z,{onClick:()=>{var e;return null===(e=h.current)||void 0===e?void 0:e.click()},children:(0,l.jsx)(w.Z,{})})}),g.map((e,t)=>(0,l.jsx)(y.Z,{title:e.tooltip,children:(0,l.jsx)(x.Z,{onClick:e.onClick,children:e.icon})},t))]})]}),o?(0,l.jsx)(C.Z,{sx:{p:2,minHeight:r,"& img":{maxWidth:"100%",height:"auto",width:"100%"}},children:t?(0,l.jsx)(R.UG,{remarkPlugins:[W.Z],components:{code:e=>{let{inline:t,className:n,children:a,...i}=e,r=/language-(\w+)/.exec(n||""),s=r?r[1]:"";return!t&&s?(0,l.jsx)(N.Z,{style:A.$E,language:s,PreTag:"div",...i,children:String(a).replace(/\n$/,"")}):(0,l.jsx)("code",{className:n,...i,children:a})},img:e=>(0,l.jsx)("img",{...e,style:{maxWidth:"100%",height:"auto",width:"100%",borderRadius:4},alt:e.alt||""})},children:t}):(0,l.jsx)(s.Z,{color:"text.secondary",align:"center",sx:{py:8},children:"暂无内容"})}):(0,l.jsx)(d.Z,{fullWidth:!0,multiline:!0,rows:Math.floor(r/24),value:t,onChange:e=>n(e.target.value),label:i,variant:"outlined",placeholder:"开始编写您的内容...支持 Markdown 语法"})]})},q=n(87179);function CreatePost(){let e=(0,Z.useRouter)(),{user:t}=(0,q.a)(),[n,v]=(0,a.useState)([]),[y,C]=(0,a.useState)(!1),[b,k]=(0,a.useState)(""),[w,T]=(0,a.useState)(""),[I,S]=(0,a.useState)({title:"",category:"",tags:[],content:""}),[_,E]=(0,a.useState)("");(0,a.useEffect)(()=>{if(!t){e.push("/");return}loadCategories()},[t,e]);let loadCategories=async()=>{try{let e=await M.lk.getCategories();e.success&&e.data&&e.data.length>0&&(v(e.data),S(t=>({...t,category:e.data[0].name})))}catch(e){console.error("加载分类失败:",e)}},handleAddTag=()=>{_.trim()&&!I.tags.includes(_.trim())&&(S(e=>({...e,tags:[...e.tags,_.trim()]})),E(""))},handleRemoveTag=e=>{S(t=>({...t,tags:t.tags.filter(t=>t!==e)}))},handleSubmit=async t=>{if(t.preventDefault(),!I.title.trim()||!I.content.trim()){k("请填写标题和内容");return}C(!0),k("");try{let t=await M.l8.createPost(I);t.success?(T("帖子发布成功！"),setTimeout(()=>{e.push("/")},2e3)):k(t.message||"发布失败")}catch(e){console.error("发布帖子失败:",e),k("发布失败，请稍后重试")}finally{C(!1)}};return t?(0,l.jsx)(f.Z,{children:(0,l.jsx)(i.Z,{children:(0,l.jsxs)(r.Z,{children:[(0,l.jsx)(s.Z,{variant:"h4",component:"h1",gutterBottom:!0,children:"发布新帖子"}),b&&(0,l.jsx)(o.Z,{severity:"error",sx:{mb:2},children:b}),w&&(0,l.jsx)(o.Z,{severity:"success",sx:{mb:2},children:w}),(0,l.jsxs)(c.Z,{component:"form",onSubmit:handleSubmit,children:[(0,l.jsx)(d.Z,{fullWidth:!0,label:"标题",variant:"outlined",margin:"normal",value:I.title,onChange:e=>S(t=>({...t,title:e.target.value})),required:!0,placeholder:"请输入帖子标题..."}),(0,l.jsx)(d.Z,{fullWidth:!0,select:!0,label:"分类",variant:"outlined",margin:"normal",value:I.category,onChange:e=>S(t=>({...t,category:e.target.value})),required:!0,children:n.map(e=>(0,l.jsx)(u.Z,{value:e.name,children:(0,l.jsxs)(c.Z,{sx:{display:"flex",alignItems:"center",gap:1},children:[(0,l.jsx)(c.Z,{sx:{width:12,height:12,borderRadius:"50%",backgroundColor:e.color}}),e.name]})},e.id))}),(0,l.jsx)(d.Z,{fullWidth:!0,label:"标签",variant:"outlined",margin:"normal",value:_,onChange:e=>E(e.target.value),onKeyPress:e=>{"Enter"===e.key&&(e.preventDefault(),handleAddTag())},placeholder:"输入标签后按回车添加",InputProps:{endAdornment:(0,l.jsx)(h.Z,{position:"end",children:(0,l.jsx)(x.Z,{onClick:handleAddTag,children:(0,l.jsx)(j.Z,{})})})}}),(0,l.jsx)(c.Z,{sx:{mb:2},children:I.tags.map(e=>(0,l.jsx)(g.Z,{label:e,onDelete:()=>handleRemoveTag(e),deleteIcon:(0,l.jsx)(p.Z,{}),sx:{mr:1,mb:1}},e))}),(0,l.jsx)(components_MarkdownEditor,{value:I.content,onChange:e=>S(t=>({...t,content:e})),label:"内容",height:500}),(0,l.jsxs)(c.Z,{sx:{display:"flex",gap:2,justifyContent:"flex-end",mt:3},children:[(0,l.jsx)(m.Z,{variant:"outlined",onClick:()=>e.back(),disabled:y,children:"取消"}),(0,l.jsx)(m.Z,{type:"submit",variant:"contained",disabled:y,children:y?"发布中...":"发布帖子"})]})]})]})})}):null}}},function(e){e.O(0,[838,349,714,708,826,774,888,179],function(){return e(e.s=70333)}),_N_E=e.O()}]);